'use strict';

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _chalk = require('chalk');

var _chalk2 = _interopRequireDefault(_chalk);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _mkdir = require('./library/mkdir');

var _mkdir2 = _interopRequireDefault(_mkdir);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var successTemplate = _fs2.default.readFileSync(__dirname + '/templates/success.xml', { encoding: 'utf-8' });

var sendRawEmail = function sendRawEmail(req, res, dateDir, fullDir, log) {
  if (!req.body['RawMessage.Data']) {
    throw new Error('RawMessage.Data is required and was not sent');
  }

  (0, _mkdir2.default)(_path2.default.join(dateDir));
  (0, _mkdir2.default)(_path2.default.join(fullDir));
  log('  \uD83C\uDF63  ' + _chalk2.default.green('Raw Email Received') + '\n    ' + _chalk2.default.blue('From:') + ' ' + req.body.Source + '\n    ' + _chalk2.default.blue('To:') + ' ' + req.body['Destinations.member.1'] + '\n    ' + _chalk2.default.blue('Raw Message:') + ' ' + process.cwd() + '/' + _path2.default.join(fullDir) + '/raw-message\n  ');
  var decodedBody = Buffer.from(req.body['RawMessage.Data'], 'base64').toString();
  _fs2.default.writeFileSync(fullDir + '/raw-message', decodedBody);

  res.status(200).send(successTemplate.replace('{{message}}', process.cwd() + '/' + _path2.default.join(fullDir) + '/raw-message'));
};

module.exports = sendRawEmail;